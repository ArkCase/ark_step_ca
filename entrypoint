#!/bin/bash
set -eo pipefail

# Paraphrased from:
# https://github.com/influxdata/influxdata-docker/blob/0d341f18067c4652dfa8df7dcb24d69bf707363d/influxdb/2.0/entrypoint.sh
# (a repo with no LICENSE.md)

export STEPPATH="$(step path)"
export CONFIGPATH="${STEPPATH}/config/ca.json"
export PWDPATH="${STEPPATH}/secrets/password"

# List of env vars required for step ca init
declare -ra REQUIRED_INIT_VARS=(DOCKER_STEPCA_INIT_NAME DOCKER_STEPCA_INIT_DNS_NAMES)

# Ensure all env vars required to run step ca init are set.
function init_if_possible () {
	local MISSING="false"
	for VAR in "${REQUIRED_INIT_VARS[@]}"; do
		[ -v "${VAR}" ] || MISSING="true"
	done
	if "${MISSING}" ; then
		>&2 echo "there is no ca.json config file; please run step ca init, or provide config parameters via DOCKER_STEPCA_INIT_ vars"
	else
		step_ca_init "${@}"
	fi
}

function generate_password () {
	set +o pipefail
	< /dev/urandom tr -dc A-Za-z0-9 | head -c40
	echo
	set -o pipefail
}

# Initialize a CA if not already initialized
function step_ca_init () {
	DOCKER_STEPCA_INIT_PROVISIONER_NAME="${DOCKER_STEPCA_INIT_PROVISIONER_NAME:-admin}"
	DOCKER_STEPCA_INIT_ADMIN_SUBJECT="${DOCKER_STEPCA_INIT_ADMIN_SUBJECT:-step}"
	DOCKER_STEPCA_INIT_ADDRESS="${DOCKER_STEPCA_INIT_ADDRESS:-:9000}"

	local -a SETUP_ARGS=(
		--name "${DOCKER_STEPCA_INIT_NAME}"
		--dns "${DOCKER_STEPCA_INIT_DNS_NAMES}"
		--provisioner "${DOCKER_STEPCA_INIT_PROVISIONER_NAME}"
		--password-file "${STEPPATH}/password"
		--provisioner-password-file "${STEPPATH}/provisioner_password"
		--address "${DOCKER_STEPCA_INIT_ADDRESS}"
	)
	if [ -n "${DOCKER_STEPCA_INIT_PASSWORD}" ]; then
		echo "${DOCKER_STEPCA_INIT_PASSWORD}" > "${STEPPATH}/password"
		echo "${DOCKER_STEPCA_INIT_PASSWORD}" > "${STEPPATH}/provisioner_password"
	else
		generate_password > "${STEPPATH}/password"
		generate_password > "${STEPPATH}/provisioner_password"
	fi
	if [ "${DOCKER_STEPCA_INIT_SSH}" == "true" ]; then
		SETUP_ARGS+=(--ssh)
	fi
	if [ "${DOCKER_STEPCA_INIT_ACME}" == "true" ]; then
		SETUP_ARGS+=(--acme)
	fi
	if [ "${DOCKER_STEPCA_INIT_REMOTE_MANAGEMENT}" == "true" ]; then
		SETUP_ARGS+=(--remote-management)
		SETUP_ARGS+=(--admin-subject "${DOCKER_STEPCA_INIT_ADMIN_SUBJECT}")
	fi
	step ca init "${SETUP_ARGS[@]}"

	echo "üëâ Creating a stronger root CA..."
	# TODO: Get the CN from the original CA to substitute here?
	OUT="$(
		step certificate create \
			--profile root-ca \
			--kty RSA \
			--size 4096 \
			--force \
			--password-file "${STEPPATH}/password" \
			"${DOCKER_STEPCA_INIT_NAME} Root CA" \
			"${STEPPATH}/certs/root_ca.crt" "${STEPPATH}/secrets/root_ca_key"
	)"
	RC=${?}
	if [ ${RC} -ne 0 ] ; then
		echo "‚ùå Failed to generate the stronger root CA (rc=${?})"
		echo "${OUT}"
		exit 1
	fi

	echo "üëâ Creating a stronger intermediate CA..."
	# TODO: Get the CN from the original Intermediate CA to substitute here?
	OUT="$(
   		step certificate create \
			--profile intermediate-ca \
			--kty RSA \
			--size 4096 \
			--force \
			--password-file "${STEPPATH}/password" \
			--ca "${STEPPATH}/certs/root_ca.crt" \
			--ca-key "${STEPPATH}/secrets/root_ca_key" \
			--ca-password-file "${STEPPATH}/password" \
			"${DOCKER_STEPCA_INIT_NAME} Intermediate CA" \
			"${STEPPATH}/certs/intermediate_ca.crt" "${STEPPATH}/secrets/intermediate_ca_key"
	)"
	RC=${?}
	if [ ${RC} -ne 0 ] ; then
		echo "‚ùå Failed to generate the stronger intermediate CA (rc=${?})"
		echo "${OUT}"
		exit 1
	fi

	echo ""
	if [ "${DOCKER_STEPCA_INIT_REMOTE_MANAGEMENT}" == "true" ]; then
		echo "üëâ Your CA administrative username is: ${DOCKER_STEPCA_INIT_ADMIN_SUBJECT}"
	fi
	echo "üëâ Your CA administrative password is: $(< "${STEPPATH}/provisioner_password" )"
	echo "ü§´ This will only be displayed once."
	shred -u "${STEPPATH}/provisioner_password"
	mv "${STEPPATH}/password" "${PWDPATH}"
}

[ -f /usr/sbin/pcscd ] && /usr/sbin/pcscd
[ -f "${STEPPATH}/config/ca.json" ] || init_if_possible

exec /usr/local/bin/step-ca --password-file "${PWDPATH}" "${CONFIGPATH}"
